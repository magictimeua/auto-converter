name: Check Empty Descriptions

on:
  workflow_run:
    workflows: ["Auto Convert and Push"]
    types:
      - completed

jobs:
  check-descriptions:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Run description checker
        run: |
          pip install lxml

          python3 - <<EOF
          from lxml import etree
          import os

          input_file = "auto-converter/converted.yml"
          output_file = "auto-converter/empty_checker.txt"

          if os.path.exists(output_file):
              with open(output_file, "r", encoding="utf-8") as f:
                  previous_ids = set(line.strip() for line in f if line.strip())
          else:
              previous_ids = set()

          with open(input_file, "r", encoding="utf-8") as f:
              content = f.read()

          if not content.strip().startswith("<root>"):
              content = "<root>\n" + content + "\n</root>"

          root = etree.fromstring(content.encode("utf-8"))

          current_ids = set()

          for offer in root.xpath(".//offer"):
              offer_id = offer.get("id")
              name_el = offer.find("name")
              desc_el = offer.find("description")

              name = name_el.text.strip() if name_el is not None and name_el.text else ""
              desc = desc_el.text.strip() if desc_el is not None and desc_el.text else ""

              if desc == "" or desc == name:
                  current_ids.add(offer_id)

          updated_ids = sorted(current_ids)

          with open(output_file, "w", encoding="utf-8") as out:
              out.write("\n".join(updated_ids))

          print(f"Було: {len(previous_ids)} | Залишилося: {len(updated_ids)} | Видалено: {len(previous_ids - current_ids)} | Додано: {len(current_ids - previous_ids)}")
          EOF
