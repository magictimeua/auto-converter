name: Check Empty Descriptions

on:
  schedule:
    - cron: '0 * * * *'   # запуск щогодини
  workflow_dispatch:       # ручний запуск

jobs:
  check_empty:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Install lxml
      run: pip install lxml

    - name: Check empty descriptions
      run: |
        python3 - <<EOF
        from lxml import etree
        import os

        input_file = "./converted.yml"
        output_file = "./empty_checker.txt"

        if not os.path.exists(input_file):
            print(f"❌ Error: Input file '{input_file}' not found!")
            exit(1)

        with open(input_file, "r", encoding="utf-8") as f:
            content = f.read()

        try:
            root = etree.fromstring(content.encode("utf-8"))
        except etree.XMLSyntaxError:
            # Якщо файл не валідний XML (наприклад, нема кореневого тегу), додаємо <root>
            content = "<root>\n" + content + "\n</root>"
            root = etree.fromstring(content.encode("utf-8"))

        offers = root.xpath(".//offer")
        print(f"Знайдено офферів: {len(offers)}")

        current_ids = set()
        for offer in offers:
            offer_id = offer.get("id")
            name_el = offer.find("name")
            desc_el = offer.find("description")

            name = name_el.text.strip() if name_el is not None and name_el.text else ""
            desc = desc_el.text.strip() if desc_el is not None and desc_el.text else ""

            if desc == "" or desc == name:
                current_ids.add(offer_id)

        if current_ids:
            print(f"Знайдено офферів з пустим або збігаючим описом: {len(current_ids)}")
        else:
            print("Офферів з пустим або збігаючим описом не знайдено")

        with open(output_file, "w", encoding="utf-8") as out:
            out.write("\n".join(sorted(current_ids)))

        print(f"\nВміст файлу {output_file} (перші 10 рядків):")
        with open(output_file, "r", encoding="utf-8") as f:
            lines = f.readlines()
            for line in lines[:10]:
                print(line.strip())
        EOF

    - name: Upload empty_checker.txt as artifact
      uses: actions/upload-artifact@v3
      with:
        name: empty-checker-results
        path: empty_checker.txt
