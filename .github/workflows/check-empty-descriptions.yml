name: Check Empty Descriptions

on:
  schedule:
    - cron: '0 * * * *'  # Ñ‰Ð¾Ð³Ð¾Ð´Ð¸Ð½Ð¸
  workflow_dispatch:

jobs:
  check_empty:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install lxml

      - name: Check and update empty descriptions
        run: |
          python3 <<EOF
          from lxml import etree
          import os

          input_file = "converted.yml"
          output_file = "empty_checker.txt"

          if not os.path.exists(input_file):
              print(f"âŒ Error: Input file '{input_file}' not found!")
              exit(1)

          with open(input_file, "r", encoding="utf-8") as f:
              content = f.read()

          try:
              root = etree.fromstring(content.encode("utf-8"))
          except etree.XMLSyntaxError:
              content = "<root>\n" + content + "\n</root>"
              root = etree.fromstring(content.encode("utf-8"))

          offers = root.xpath(".//offer")
          print(f"\nÐ—Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ Ð¾Ñ„Ñ„ÐµÑ€Ñ–Ð²: {len(offers)}")

          ids = []
          for offer in offers:
              offer_id = offer.get("id")
              name_el = offer.find("name")
              desc_el = offer.find("description")

              name = name_el.text.strip() if name_el is not None and name_el.text else ""
              desc = desc_el.text.strip() if desc_el is not None and desc_el.text else ""

              if desc == "" or desc == name:
                  ids.append(offer_id)

          print(f"Ð—Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ Ð¾Ñ„Ñ„ÐµÑ€Ñ–Ð² Ð· Ð¿ÑƒÑÑ‚Ð¸Ð¼ Ð°Ð±Ð¾ Ð·Ð±Ñ–Ð³Ð°ÑŽÑ‡Ð¸Ð¼ Ð¾Ð¿Ð¸ÑÐ¾Ð¼: {len(ids)}")

          with open(output_file, "w", encoding="utf-8") as out:
              out.write("\n".join(sorted(ids)))

          print(f"\nâœ… Ð¤Ð°Ð¹Ð» ÑƒÑÐ¿Ñ–ÑˆÐ½Ð¾ Ð¾Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾: {os.path.abspath(output_file)}")

          with open(output_file, "r", encoding="utf-8") as out:
              print("\nÐ’Ð¼Ñ–ÑÑ‚ Ñ„Ð°Ð¹Ð»Ñƒ empty_checker.txt (Ð¿ÐµÑ€ÑˆÑ– 10 Ñ€ÑÐ´ÐºÑ–Ð²):")
              for i, line in enumerate(out):
                  if i >= 10:
                      break
                  print(line.strip())
          EOF

      - name: Commit updated empty_checker.txt
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add empty_checker.txt
          git diff --cached --quiet || git commit -m "ðŸ”„ update empty_checker.txt"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
